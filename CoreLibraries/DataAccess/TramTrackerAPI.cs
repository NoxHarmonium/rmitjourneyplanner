// -----------------------------------------------------------------------
// <copyright file="TramTrackerAPI.cs" company="">
// TODO: Update copyright text.
// </copyright>
// -----------------------------------------------------------------------

namespace RmitJourneyPlanner.CoreLibraries.DataAccess
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    using System.Text.RegularExpressions;
    using System.Xml;

    /// <summary>
    /// Interfaces with the Yarra Trams Tramtracker SOAP webservice to get various data.
    /// </summary>
    public class TramTrackerAPI : XMLRequester
    {
        /// <summary>
        /// The regular expression that defines the correct format of a client UUID.
        /// </summary>
        private const string uuidFormat = "[a-zA-Z0-9]{8}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{12}";
        
        private string guid;
        private string clientType;
        private string clientVersion;
        private string clientWebServiceVersion;
        private string osVersion;

        public TramTrackerAPI() : base (Urls.TramTrackerUrl)
        {
            this.guid = getNewGuid();              
        }

        private string getNewGuid()
        {
            //Set parameters
            base.RequestType = RequestType.SOAP;
            base.SoapXmlNamespace = Urls.TramTrackerUrl;
            base.SoapAction = Urls.GetNewClientGuid;
            base.Parameters["GetNewClientGuid"] = null;
            //Request data
            XmlDocument doc = base.Request();
            
            //Get response data
            XmlNode response = doc["soap:Envelope"]["soap:Body"]["GetNewClientGuidResponse"];
            return response["GetNewClientGuidResult"].InnerText;
        }

        /// <summary>
        /// Gets the client GUID generated by the TramTracker API.
        /// </summary>
        public string Guid
        {
            get
            {
                return guid;
            }
        }

        private XmlNode generateHeader()
        {

            /*
              Header Template:
             * <PidsClientHeader xmlns="http://www.yarratrams.com.au/pidsservice/">
                <ClientGuid>guid</ClientGuid>
                <ClientType>string</ClientType>
                <ClientVersion>string</ClientVersion>
                <ClientWebServiceVersion>string</ClientWebServiceVersion>
                <OSVersion>string</OSVersion>
                </PidsClientHeader>
             */
            XmlDocument doc = new XmlDocument();

            XmlNode nClientHeader = doc.CreateElement("PidsClientHeader", base.SoapXmlNamespace));
            XmlNode nClientGuid = doc.CreateElement("ClientGuid");
            XmlNode nClientType = doc.CreateElement("ClientType");
            XmlNode nClientVersion = doc.CreateElement("ClientVersion");
            XmlNode nClientWebServiceVersion =doc.CreateElement("ClientWebServiceVersion");
            XmlNode nOsVersion = doc.CreateElement("OSVersion");
            

            return null;
        }

        /// <summary>
        /// Returns true if the supplied string is in the correct format for a client UUID.
        /// </summary>
        /// <param name="uuid"></param>
        /// <returns></returns>
        public bool IsValidUuid(string uuid)
        {            
            return new Regex(uuidFormat).IsMatch(uuid);
        }

    }
}
